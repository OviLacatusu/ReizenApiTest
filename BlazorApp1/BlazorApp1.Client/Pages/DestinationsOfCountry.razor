@using Reizen.CommonClasses.DTOs
@using Microsoft.AspNetCore.Authorization

@page "/{NameCountry}/Destinations"

@inject IHttpClientFactory _httpFactory
@inject ILogger<DestinationsOfCountry> _logger;

@* @attribute [Authorize] *@
<div class="container">
    <h2>Choose the destination:</h2>

    <img src="/vlaggen/@(NameCountry).png" />

    @if (Destinations != null)
    {
        <ul>
            @foreach (var Destination in Destinations)
            {
                <li>
                    <div class="row">
                        <div class="col col-md-2">
                            <a href="/@Destination.Code/trips">@Destination.PlaceName</a>
                        </div>
                        <div class="col col-md-3">
                            @if (tripsNaarDestination?[Destination.Code]?.Count() > 0) 
                            {
                                <p> - @tripsNaarDestination?[Destination.Code]?.Count() available trips</p>
                            }
                            else 
                            {
                                <p> - no available trips</p>
                            }
                        </div>
                    </div>
                </li>
            }
        </ul>
    }
    else
    {
        <p>Waiting for data...</p>
    }
    @if (!String.IsNullOrEmpty(Error))
    {
        <div class="alert alert-danger">@Error</div>
    }
</div>

@code {
    [Parameter]
    public string? NameCountry { get; set; }

    private string? Error { get; set; }

    private IEnumerable<DestinationDTO>? Destinations;

    private IDictionary<string,IEnumerable<TripDTO>>? tripsNaarDestination = new Dictionary<string,IEnumerable<TripDTO>>();

    protected override async Task OnInitializedAsync()
    {
        if (!String.IsNullOrEmpty(NameCountry))
        {
            using var httpClient = _httpFactory.CreateClient();

            var result = await HelperRequest.SendGetRequestAndParseJsonAsync<IEnumerable<DestinationDTO>>($"api/Destinations/{NameCountry}", httpClient);
            if (result.IsSuccessful)
            {
                Destinations = result.Value;
                await GetAvailableTripsForEachDestination();
            }
            else
            {
                Error = result.Error;
            }
        }
    }
    private async Task GetAvailableTripsForEachDestination()
    {
        foreach (var Destination in Destinations)
        {
            using var httpClient = _httpFactory.CreateClient();

            var result = await HelperRequest.SendGetRequestAndParseJsonAsync<IEnumerable<TripDTO>>($"api/trips/{Destination.Code}", httpClient);
            if (result.IsSuccessful)
            {
                tripsNaarDestination.Add(Destination.Code, result.Value);
            }
            else
            {
                tripsNaarDestination.Add(Destination.Code, null);
                //Error += result.Error;
            }
        }
    }
}
